\documentclass[nolof,digital]{fithesis3}
\thesissetup{faculty=fi}
\thesissetup{author=Bc. Lukáš Tyrychtr,id=422294, departmentEn = Faculty of Informatics, programmeEn = Applied Informatics, fieldEn = Applied Informatics, assignment = {}}
\thesissetup{type= mgr}
\thesissetup{title=Feel the streets - a visually impaired user access to OSM maps}
\thesissetup{keywords = {visually impaired, navigation, accessibility, Open Street Map, usability}}
\usepackage[english]{babel}
\usepackage{alltt}
\usepackage{listings}
\usepackage{csquotes}
\usepackage[hidelinks]{hyperref}
\usepackage[style=ieee,sorting=nty,block=ragged]{biblatex}
\renewbibmacro*{bbx:savehash}{} %disabling dashing
\addbibresource{bibliography.bib}
\usepackage{tabularx}
\usepackage{placeins}
\usepackage{tabu}
\usepackage{algorithm2e}
\SetAlCapSkip{3mm}
\thesislong{abstract}{

}
\thesissetup{advisor=Ing. Milan Brož\, Ph.D.}
\thesislong{thanks}{
}
\thesisload
\setcounter{tocdepth}{2}
\begin{document}
\chapter{Introduction}
\chapter{Map presentation approaches}
This chapter describes the various approaches which were used to present maps to visually impaired people, mainly focusing on tactile maps and various application for smart phones and desktop operating systems.
\section{Printed maps}
This section describes the usage of printed maps.
\section{Mobile phone apps}
This section explores the various mobile phone apps used for navigation by visually impaired people as well as the usability of standard map applications on the respective mobile phone operating systems.
\section{Desktop apps}
In this section, the few desktop applications for navigation purposes are explored.
\chapter{Feel the streets}
This chapter describes the implementation of Feel the streets, an application for browsing Open Street Maps data by visually impaired people, its features, implementation decisions and some noteworthy events in the application development.
\section{Feature overview}
From the user's perspective, Feel the Streets is a desktop application which, when launched, allows the user to browse OpenStreetMap maps without sight.
\subsection{Area selection}
After startup, the application presents a list of the available areas from which the user can choose one which he wants to browse. This list is usually retrieved from the Feel the Streets server, so it includes all the available areas, but when there is no network connectivity, the locally available areas are shown instead.

The areas list shows the area's name, last modification and creation times formatted according to the user's locale preferences, the area size and its state. The state represents the status of the area's database and it usually reports that the area is updated. Other states exist as well, namely states for an area which is just being created, for which we are just now retrieving the incremental changes or we are applying them. A special concept of frozen areas exists, these areas can be downloaded, but after creation, no changes are applyed on them, which is useful for research reproducibility.

From the area selection window the user can also request an area which is not yet available. If he does so, he is prompted for the area's name and if there are multiple candidates, he is then offered the list of the areas to specify which one he actualy means. This selection process is helped by including all the area properties in the candidate details window.

By selecting an area a set of steps starts. If he selected area is not yet downloaded to the user's computer, the download is performed. If it is, the application checks for all the changes which occurred to the area between the last check and now and applies them. After these steps, the user ends up in the main window.
\subsection{the main window}
The main window of the application is seemingly simple - just an empty window with a menubar on top. Despite this, it is the central piece of the user interface of the application.

This is the window where the actual map exploration occurs. Because of that, it contains all the relevant commands.

The first group of commands allows the user to move in the environment. It allows him to do a forward and backward step, turn around in 5 and 90 degree increments, rotate by a given amount and jump to a particular set of GPS coordinates.

The next group of commands allows the user to determine his location. He can request a short summary of it, or he can request a more detailed view of it using the near by objects window, which is described in a subsequent subsection. The user can also request a list of near by objects. Usually some objects are not considered (like routes and similar relatively big objects), but the user can request the location or near by objects without ignoring these.

The next group of commands provides various additional information about the application's state. These additional commands include reporting the user's current GPS coordinates, his direction or they allow him to browse the history of spoken messages during the current application run, the speech history is not saved between restarts of the application.

There is also a set of commands which allows toggling some of the application settings.
\subsection{Search}
The application also allows performing searches in the data. There are two search facilities.

The first is a simple search based on a partial name match. The user can enter a part of the desired name and every object which has that particular substring in its name tag is returned.

When the name search is not sufficiently detailed, the user can use the advanced search. In this mode he is first required to select which kind of object he wants to search (everything with an address, shops, buildings etc). After the selection, he can specify additional conditions based on the selected entity's fields. For strings it is possible to use exact or partial matches, for numbers, all the usual operators are available. The user can specify any number of conditions which are then combined into the final query as if there was a logical and operator between them.

In both of the search modes the results are displayed using the same window which is used for the near by objects.
\subsection{The objects list window}
This window is used for displaying a list of objects. This list can come from a near by query, a search, or it can be a result of a parent/child query as well.

The window shows a list of objects represented as short descriptions of them, in each case it contains the entity class of it and some details (like the name, amenity type) for some of the classes. In addition, when an object is selected, all the properties (basically OpenStreetMap tags when not counting some renaming of the tag names) are displayed. In addition, the user can expand a part of the properties which contains the revision information including the last changed date, the user who did the change, the changeset number and this section also shows the id of the object which is the OpenStreetMap id prefixed by a letter (n for nodes, w for ways and r for relations) to allow the user to communicate exactly which object might require some fixes, for example.

The window also allows performing additional actions of some of the objects. The more useful of these actions include opening a website related to the object or opening its Wikipedia entry. The actions also allow viewing the parents (e. g. the relations or ways which contain the given object) or the object's children. From the parents, it is for example possible to determine the public transport line related to a railway.
\subsection{Navigational sounds}
During navigation, the application plys some sounds to help the user in visualizing the relationships between the object positions and distances.

As a first clue, it plays sounds for some objects, currently for land areas, shops and trash cans. These sounds are played on the correct 3d cartesian coordinates so the relationships between them are preserved.

In addition to these sounds, the application also plays sounds for crossings.

Both of these groups of sounds can be turned on and off, if desired.
\subsection{Automatic announcements of interesting objects}
To help the user discover potentially interesting objects, the application automatically announces some of the near by entities. This announcement uses much shorter distance than the near by objects scan, because for now, the object is announced regardless of its reachability, so it might be possible that an object is announced even if it is behind some other buildings, for example.

These announcements can of course be turned off using a configuration option.
\section{Technical overview}
This section describes the currently used technologies which are used by the Feel the Streets client and server. The technologies have changed quite extensively during the development, so the Development history section then presents the various choices which were made during the lifetime of the application.

As of now (commit f316b17d63), the application is comprised of two major components and some supporting libraries and utilities. The major components are the client and server applications, respectively. They share the area database access layer through python bindings.
\subsection{THe client}
The client is the main application which all the users interact. It handles downloading of the area databases, applying updates and browsing the respecive areas.

The client application is written in the Python programming language. Python was chosen mainly because it was familiar and had good library support for all the subsystems.

For the user interface, the Qt library is being used as it has the best cross platform accessibility story despite some mainly Windows specific issues.

For the sound engine, the client application uses OpenAL and the HRTF extension. That means that the OpenAL Soft library is required.
\subsection{The server}
The server mainly handles management of area databases. It handles the area creation requests from the clients and to help the clients keep their local databases updated it also creates a list of changes which the clients can download afterwards.

It is written in the Rust programmng language, mainly for speed and memory usage reasons. The static typing helped the development as well, it was not so uncommon to find an error which a statically typed language would prevent.

For storage of the area databases the Sqlite3 library is used. To perform the needed geospatial queries, the Spatialite extension is being used.

For communication with the client application the server exposes a HTTP API for area lists, download requests and similar functionality. 

For storing the area changes a Rabbitmq server is used. It allows to keep the queue semantics quite easily. The clients do not have full administrative access to the Rabbitmq server when connecting, they are limited by an access control list and the connection is also secured using Transport layer security.

To keep the number of additional components as low as possible, Rabbitmq is also used for background tasks storage and for background task scheduling. The scheduling uses the message's time to live and it instruct Rabbitmq to put the message to the ready messages queue after the TTL expires.

The server uses compression extensively to minimize the storage requirements. The main savings are by compressing the individual area database changes before putting them to the Rabbitmq queue. The compression uses the Zstd compression algorithm which allows, among other things, to use a pretrained compression dictionary for compression, which gives much better results than compressing the individual messages on its own - it gave an improvement at least of 50% in message sizes on average.
\subsection{The shared library}
The handling of area databases is actually implemented in a shared library, called osm_db, which is called from the server code and from Python as well. To allow calling the library from Python, creating a binding library was necessary. Fortunately, by using the Pyo3 Rust library, that efford was relatively straightforward. The Python library does not expose the entire public API of osm_db, only the parts which the client application requires, which means basically the complete query API and a way to apply database changes.
\section{Development history}
This section presents the development history of Feel the Streets, the various approaches used and their advantages and disadvantages. It also mentions some of the accessibility issues which are further described in the issues encountered along the way section. This section does not describe each commit of the Feel the Streets repository, it mentions only the more important ones.
\subsection{The beginnings}
The first commit of the Feel the Streets project occurred on the 18th of August 2017. At this time, the application's GUI used the Wx widgets library and there was no server component. The area database access was handled using the sqlalchemy library and it used the sqlalchemy's table inheritance features, so there was a separate table for each entity class.

The next commit, which was quite huge, added the initial implementation of the database update logic.

In commit 683215bbe1, the search functionality was added.
\subsection{Table inheritance removal}
It turned out, mainly because of the search functionality, which required quite huge joins and it managed to cross the Sqlite3's maximum column count for a query result as well, that the approach which used a separate table for each entity was not sustainable. As a result, in commit 3a02c10710 the area database structure was changed so all the entities were stored in a single table with the entity properties stored in a json object. This storage approach survived to the current version of Feel the Streets, except for some minor modifications. The application representation stayed largely similar, the entity classes kept a Python class, but these classes existed only for the application and used the Pydantic data validation library.
\subsection{Bookmarks appear}
In commit dbb8a71b2b the initial support for bookmarks was added. The bookmarks were stored in the area database, which was changed in commit 30d56506d9 to allow safe area redownloads. Bookmarks underwent The last change of the bookmark representation occurred in commit 49bc7331ae which added the direction the user was facing when creating the bookmark which was not stored before.
\subsection{The server is born}
Because of the need to update the area databases incrementally and not downloading them each time, commit 8fe9a7548f introduced a concept of semantic changes of OSM objects. The following commit introduced the server component and moved the update logic there and in commit fab61d9f61 the server API was introduced.

When the server API was in place, commit d791a35bad allowed the users to select a map. 

And some commits later, when the server's capability to run an update of all area databases was deemed stable enough, commit b2fd5c4943 implemented the client side of area updates.
\subsection{Object actions}
In commit 62a1454247 the framework for executing actions on object was introduced. Some commits later, the wikipedia and wikidata open actions were implemented along with other website like things which could e opened, like the ruian details of a czech building.
\subsection{The rustification efford}
Because of the languages used, the server memory consumption and speed was not ideal. To improve the situation, a quite drastic measurement was taken starting from commit 67b194c60a, the entire server component was small piece at a time rewritten into Rust. That required rethinking the way how the entity properties and generator property mappings are stored, so the server used a few yaml files to store the entity classes and their properties, the enums inherent in the data and the translation transformations. The server rewrite efford was merged into master in commit 42a9e4762a.

In commit b5b9ea13a1 the creation of python bindings of osm_db has started. That allowed getting rid of the python entity classes and access to the area database was unified.
\subsection{Area names are not enough}
Up until commit acf47daa00 the server assumed that areas will have unique names. The fact that it might not be true was not the reason for the changes in the mentioned commit, the reason was just a curiosity whether it is possible to generate an area database for Antwerpen and finding out that the previous entity retrieval query chose the wrong area for it. As a result, the ids of the OSM areas began to be stored instead.

This was then used in commit ab8940113c which allowed the user to select an area when the requested area name was not unambiguous.
\subsection{The move to OpenAL}
In commit 21d703b0e4 the entire sound subsystem was changed from using the Fmod library to OpenAL. The reasons for the change included much easier installations under Linux - the OpenAL library was in all the needed package repositories and usage of the OpenAL's HRTF capabilities became possible as well.

The previously mentioned HRTF support was not used until commit 7f6997cd54, however.
\subsection{Changing the GUI library}
While doing Linux testing of Feel the Streets, it turned out that the Wx widgets tree control completely lacks accessibility on that platform. Rather than trying to fix it and push that change through review, a change to a different GUI library was chosen as the solution. Qt was chosen as it was reasonably accessible on all platforms. The rewrite started in commit 864a478d3e and was mainly finished a commit after.
\subsection{Continuous integration and deployment}
During the Rust rewrite, a continuous integration configuration was started in commit 78cb752449. When it was created, it only built the source code, but deployment was also added so after a successful build the binaries were pushed to the server where the API ran. This work was finished in commit 90d4e4afec. This version of the CI process was running only on Linux, however.

That changed in commit 3117283f7d and some time later, namely in commit 42c673ef9b we were building something resembling a Windows binary.

Some months later, Travis CI policy to ward open source repositories began to change, so in commit acc0e75618 the Travis CI configuration was dropped after the GitHub Actions configuration mainly worked.
\subsection{Interesting objects appear}
Mainly due to some discussions with the thesis advisor, the commit 9e861a7780 introduced the concept of interesting objects. The subsequent commits implemented announcing these and moving until one is found.
\subsection{Drop the synthetic ID}
Mainly due to the need to conserve any space, possible, commit 1978dfa944 dropped auto-incrementing ids for entities in the entity databases and started using the id of the OSM entity prefixed by its type instead.

To make the interesting objects more useful, the commit ffe2566d94 added a way for interesting objects to emit a sound.
\subsection{Keeping the OSM relationships}
Up until commit 64a5a5a650 the processing step did not preserve the relationships, so it was not possible to determine which nodes were part of a way or relation. This fact was deemed useful enough for future improvements that the relationships were added to the area databases.

After that, commit 5dd07d459f added a client side possibility to view the parents and children of an OSM object.

In addition to the relationships inherent from the OSM data, commit 6d65d9421c extended the entities relationships to allow arbitrary relationship types like streets of an entity and addresses as well. 
\subsection{Making crossings useful}
To be as helpful as possible, in commit 58f932d6a4 the application started describing crossings when the user entered them. Making this at least somewhat right was not an easy task, so the exact details are described in the Issues encountered along the way section.

To help the user find them more easily, in commit 3348fc5772 a sound which played on their positions was added.
\subsection{Getting rid of one object relational mapper}
When profiling the startup times of the Feel the Streets client, it turned out that using the Sqlalchemy library for interactions with the database which stored bookmarks and last locations added a significant startup time cost. So in commit 2e5e6438ea Sqlalchemy was replaced by direct database calls.
\subsection{Avoiding footways}
Because of some more discussions during the previews of the state of Feel the Streets during that time period, it was decided that it would be useful to allow the user to avoid footways as much as possible. That started in commit 6ccdbe9522. There were some fixes needed to make this functionality work, but they will be described in the encountered issues section.
\subsection{Making things smaller}
To be as space efficient as possible, commit 18cf5ad1bd added compression for raw OSM objects which resulted from a query. It also disabled removing this cache. That allowed update times to shorter, because when computing a geometry of an object we did not need to request the entities which comprised the parent's geometry (e. g. all nodes for a way etc.) if they did not change.

To make some more things smaller, commit e3894ed98a introduced compression for the semantic changes so they weren't published uncompressed to the change queues.
\subsection{Frozen areas}
To help the upcoming usability study be as reproducibžýle ažřs possible, commit 7f17848c42 introduced a concept of a frozen area which does not receive updates. Subsequent commits teached the rest of the codebase about them and allowing freezing already existing areas.
\subsection{Message of the day}
To allow informing the testers of a possible important update, commit de86753ebe added a concept of a message of the day and the next one added the client capabilities.
\subsection{Fixing the sound positioning}
Just after starting the user study, one of the testers discovered a pretty serious sound positioning related issue which sparked a chain of commit starting with commit a9b92a9704 and ending by commit 0930afcecb. As this issue deserve a more thorough description, it is described in the encountered issues section as well.
\section{Issues encountered along the way}
This section describes the various issues encountered during the development of Feel the Streets. Many of them were related to the OSM data or the data model, but there were some accessibility related issues as well.
\subsection{Representing crossings}
During much of the development of Feel the Streets, when an user entered a crossing, only the standard messages for entered roads were announced. That was deemed unsuitable and not informational rich, so a special message was added to the application. That resulted in a series of bug fixes for various corner cases which this section describes.

The first bunch of issues was related to the announcements of the ways you could turn on a road. Due to a broken computation, the possibility of letf turns was hidden for a time. Also, the application reported turns which turned the user about 0 degrees as well, which was not necessary.

Another issue with the crossing announcements logic was that you were notified about a crossing, but the fact that the road which lead you to it actually continued was hidden from the user. That was remedied in commit 0e127d6900. Of course, the additio was not flawless, it turned out that filtering turns about zero degrees does not help when you want to know for how long you can go along the current road, that's the reason why commit 1046631dae exists.

Another bug related to the crossing announcements was actually in the logic which determined which objects are currently intersecting with your position. Up until that time, the spatial intersection query for quickly ruling most of the entities through a R Tree based index assumed a rectangle without size. That however caused an inability to enter the crossing entity when it lay on the geometric intersection of two roads. This issue was fixed in commit 8cbc40c987.

Of course, real world crossings can have more than two roads meet in the crossing. The continuation announcements logic did not account for that, however, so it had to be changed and what the user entered had to be taken into account. These changes happened in commit 7f9edf1034.

Some crossings posed another challenge. For these a road continued more or less straight but with a different name. Up until commit d9aebc79fc, this event was announced as crossing of a road. This revision however changed the logic such that these events were announced as road continuations with a changed name.

When the user entered a road until commit c5221a8783, the road announcement logic only took into account the roads which the user entered. However, these entry points usualy weren't in the point where the geometric intersection of the roads actually lay, so there could be more roads which crossed there, but the user did not enter them yet (mainly roads with pretty sharp turn angles). This commit began actively searching for all the crossing roads and in commit c9748062d7, the user was actually moved to the geometric crossing so the entity entering machinery had all the data it needed to produce the correct messages.

Commit 66f6813d78 fixed another set of crossing reporting issues. The first was related to the type of crossing where you enter it, a differently named road continues for example left, and the right turn is a road with the same name as the one you used to enter the crossing. In this case, the user should be informed about the turn, but until this commit, the duplicate name filtering logic, which allowed the user to not know about roads split because of a different set of tags prevented the announcement. On the other hand, entering a crossing with two roads of the same name was not filtering the second as well, so this commit fixed that case as well.

When you enter  a crossing in the real world, it is obvious that you can not continue in the current direction, but the Feel the Streets users were not notified about that fact unil commit 1ecfecb491 which added these announcements. In commit 93443975d8 the message was made more specific and started to mention the road which was ending on the crossing.
\subsection{Footways}
\subsection{Accessibility issues}
Despite it not being as common, some accessibility issues were discovered along the project's development. The first was fixed in commit b59c596555 and was related to some quite weird NVDA announcements in a treeview when the treeview had all items removed. The reason for the issue was not sought further, the workaround was deemed sufficient.

The second was discovered after the switch to Qt. The issue was that on Windows, screen readers were not announcing the collapsed/expanded state of a treeview. The cause was discovered to be related to Qt's UI Automation handling which did not expose this information. A bug report for this issue already existed in the Qt bug tracker, but it did not receive any useful comments.
\subsection{Sound positioning issues}

\chapter{Usability study}
This chapter presents the study which was carried between visually impaired users concerning the usability of Feel the streets
\section{Study description}
This section briefly describes the study and its goals
\section{About the subjects}
This section describes the subjects and general reasons for the particular selection.
\section{Methodology}
This section describes the methodology of the study and gives a reasoning for choosing the particular methods.
\section{The questions and the answers}
In this section, the questions are presented, along with the summarized answers.
\chapter{Conclusion}
\section{In summary}
\section{Future work}
\end{document}